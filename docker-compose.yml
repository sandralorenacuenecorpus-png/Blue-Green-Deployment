version: '3.8'

services:
  # Nginx como Load Balancer / Router
  nginx:
    image: nginx:alpine
    container_name: load_balancer
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf  # ← Quitar :ro
      - ./nginx/switch.sh:/switch.sh
    networks:
      - blue-green-network
    depends_on:
      - blue-app
      - green-app

  # Entorno BLUE (Versión 1.0)
  blue-app:
    build:
      context: ./app
      dockerfile: Dockerfile
      args:
        VERSION: "1.0"
        COLOR: "blue"
    container_name: blue_service
    environment:
      - APP_VERSION=1.0
      - APP_COLOR=blue
      - APP_NAME=Blue Environment
    networks:
      - blue-green-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Entorno GREEN (Versión 2.0)
  green-app:
    build:
      context: ./app
      dockerfile: Dockerfile
      args:
        VERSION: "2.0"
        COLOR: "green"
    container_name: green_service
    environment:
      - APP_VERSION=2.0
      - APP_COLOR=green
      - APP_NAME=Green Environment
    networks:
      - blue-green-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Base de datos compartida
  database:
    image: postgres:15-alpine
    container_name: shared_database
    environment:
      - POSTGRES_DB=bluegreen_db
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=secret123
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - blue-green-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Monitor de estado
  monitor:
    image: alpine:latest
    container_name: deployment_monitor
    command: sh -c "while true; do wget -qO- http://nginx 2>/dev/null && echo '---'; sleep 2; done"
    networks:
      - blue-green-network
    depends_on:
      - nginx

networks:
  blue-green-network:
    driver: bridge

volumes:
  db_data: